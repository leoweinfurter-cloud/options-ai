<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options AI Predictor v1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f; --bg-secondary: #12121a; --bg-tertiary: #1a1a25; --bg-card: #15151f;
            --accent-green: #00ff88; --accent-red: #ff3366; --accent-blue: #00d4ff;
            --accent-purple: #a855f7; --accent-yellow: #fbbf24; --accent-orange: #ff6b35;
            --text-primary: #ffffff; --text-secondary: #a0a0b0; --text-muted: #606070;
            --border-color: #2a2a3a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Space Grotesk', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse at 20% 20%, rgba(0,255,136,0.05) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(0,212,255,0.05) 0%, transparent 50%); pointer-events: none; z-index: 0; }
        
        /* ========== LOGIN SCREEN ========== */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-overlay.hidden {
            display: none;
        }
        .login-container {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 48px;
            width: 100%;
            max-width: 420px;
            margin: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue), var(--accent-purple));
        }
        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }
        .login-logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            box-shadow: 0 0 40px rgba(0,255,136,0.3);
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .login-logo h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .login-logo p {
            color: var(--text-muted);
            font-size: 14px;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .login-input-group {
            position: relative;
        }
        .login-input-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .login-input-wrapper {
            position: relative;
        }
        .login-input-wrapper .icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            opacity: 0.5;
        }
        .login-input {
            width: 100%;
            padding: 16px 16px 16px 48px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .login-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(0,212,255,0.1);
        }
        .login-input::placeholder {
            color: var(--text-muted);
        }
        .toggle-password {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
            transition: color 0.3s ease;
        }
        .toggle-password:hover {
            color: var(--accent-blue);
        }
        .remember-me {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .remember-me input[type="checkbox"] {
            display: none;
        }
        .checkbox-custom {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .checkbox-custom::after {
            content: '‚úì';
            color: var(--bg-primary);
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .remember-me input[type="checkbox"]:checked + .checkbox-custom {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border-color: transparent;
        }
        .remember-me input[type="checkbox"]:checked + .checkbox-custom::after {
            opacity: 1;
        }
        .remember-me span {
            font-size: 14px;
            color: var(--text-secondary);
        }
        .login-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border: none;
            border-radius: 12px;
            color: var(--bg-primary);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
        }
        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,255,136,0.3);
        }
        .login-btn:active {
            transform: translateY(-1px);
        }
        .login-error {
            background: rgba(255,51,102,0.1);
            border: 1px solid rgba(255,51,102,0.3);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--accent-red);
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .login-error.show {
            display: flex;
        }
        .login-footer {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        .login-footer p {
            font-size: 12px;
            color: var(--text-muted);
        }
        .login-footer .security-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding: 8px 16px;
            background: rgba(0,255,136,0.1);
            border: 1px solid rgba(0,255,136,0.2);
            border-radius: 20px;
            font-size: 11px;
            color: var(--accent-green);
        }
        
        /* ========== MAIN APP (hidden initially) ========== */
        .app-container {
            display: none;
        }
        .app-container.visible {
            display: block;
        }
        
        .container { position: relative; z-index: 1; max-width: 1600px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border: 1px solid var(--border-color); border-radius: 16px; margin-bottom: 24px; position: relative; overflow: hidden; flex-wrap: wrap; gap: 16px; }
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--accent-green), var(--accent-blue), var(--accent-purple)); }
        .logo { display: flex; align-items: center; gap: 16px; }
        .logo-icon { width: 50px; height: 50px; background: linear-gradient(135deg, var(--accent-green), var(--accent-blue)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 0 20px rgba(0,255,136,0.3); }
        .logo-text h1 { font-size: 24px; font-weight: 700; background: linear-gradient(135deg, var(--accent-green), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-text span { font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .status-badges { display: flex; gap: 12px; flex-wrap: wrap; }
        .badge { padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; font-family: 'JetBrains Mono', monospace; display: flex; align-items: center; gap: 8px; }
        .badge-model { background: rgba(168,85,247,0.15); border: 1px solid rgba(168,85,247,0.3); color: var(--accent-purple); }
        .badge-api { background: rgba(0,255,136,0.15); border: 1px solid rgba(0,255,136,0.3); color: var(--accent-green); }
        .badge-telegram { background: rgba(0,212,255,0.15); border: 1px solid rgba(0,212,255,0.3); color: var(--accent-blue); }
        .badge-logout { background: rgba(255,51,102,0.15); border: 1px solid rgba(255,51,102,0.3); color: var(--accent-red); cursor: pointer; transition: all 0.3s ease; }
        .badge-logout:hover { background: rgba(255,51,102,0.3); }
        .pulse { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
        .pulse-green { background: var(--accent-green); }
        .pulse-blue { background: var(--accent-blue); }
        .pulse-purple { background: var(--accent-purple); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; transform: scale(1.2); } }
        .nav-tabs { display: flex; gap: 8px; background: var(--bg-secondary); padding: 8px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 24px; flex-wrap: wrap; }
        .nav-tab { flex: 1; min-width: 120px; padding: 14px 24px; background: transparent; border: none; color: var(--text-secondary); font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .nav-tab:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-tab.active { background: linear-gradient(135deg, var(--accent-green), var(--accent-blue)); color: var(--bg-primary); }
        .tab-panel { display: none; animation: fadeIn 0.3s ease; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 12px; }
        .card-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        @media (max-width: 1200px) { .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } .nav-tabs { flex-direction: column; } }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        .form-input, .form-select { width: 100%; padding: 12px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 14px; transition: all 0.3s ease; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(0,212,255,0.1); }
        .form-select option { background: var(--bg-secondary); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-green), var(--accent-blue)); color: var(--bg-primary); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 20px rgba(0,255,136,0.3); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-success { background: rgba(0,255,136,0.2); color: var(--accent-green); border: 1px solid rgba(0,255,136,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .btn-lg { padding: 16px 32px; font-size: 16px; }
        .metric-card { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; position: relative; overflow: hidden; }
        .metric-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
        .metric-card.green::before { background: var(--accent-green); }
        .metric-card.blue::before { background: var(--accent-blue); }
        .metric-card.purple::before { background: var(--accent-purple); }
        .metric-card.yellow::before { background: var(--accent-yellow); }
        .metric-card.red::before { background: var(--accent-red); }
        .metric-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .metric-value { font-size: 28px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .metric-value.green { color: var(--accent-green); }
        .metric-value.blue { color: var(--accent-blue); }
        .metric-value.purple { color: var(--accent-purple); }
        .metric-value.yellow { color: var(--accent-yellow); }
        .metric-value.red { color: var(--accent-red); }
        .metric-change { font-size: 12px; margin-top: 8px; }
        .progress-container { margin: 20px 0; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .progress-bar { height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-green), var(--accent-blue)); border-radius: 4px; transition: width 0.5s ease; }
        .prediction-display { text-align: center; padding: 40px; background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border-radius: 16px; border: 1px solid var(--border-color); }
        .prediction-display.bullish { border-color: rgba(0,255,136,0.3); }
        .prediction-display.bearish { border-color: rgba(255,51,102,0.3); }
        .prediction-display.neutral { border-color: rgba(251,191,36,0.3); }
        .prediction-icon { font-size: 64px; margin-bottom: 16px; }
        .prediction-label { font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
        .prediction-trend { font-size: 36px; font-weight: 700; margin-bottom: 16px; }
        .prediction-confidence { font-size: 18px; color: var(--text-secondary); }
        .confidence-bar { width: 200px; height: 12px; background: var(--bg-tertiary); border-radius: 6px; margin: 16px auto; overflow: hidden; }
        .confidence-fill { height: 100%; border-radius: 6px; transition: width 0.5s ease; }
        .confidence-fill.high { background: var(--accent-green); }
        .confidence-fill.medium { background: var(--accent-yellow); }
        .confidence-fill.low { background: var(--accent-red); }
        .strategy-card { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; text-align: center; transition: all 0.3s ease; position: relative; }
        .strategy-card:hover { transform: translateY(-4px); border-color: var(--accent-blue); }
        .strategy-card.recommended { border-color: var(--accent-green); box-shadow: 0 0 20px rgba(0,255,136,0.3); }
        .strategy-icon { font-size: 40px; margin-bottom: 12px; }
        .strategy-name { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .strategy-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; }
        .strategy-stats { display: flex; justify-content: center; gap: 20px; font-size: 12px; }
        .strategy-stat { text-align: center; }
        .strategy-stat-value { font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .chart-container { position: relative; height: 300px; margin: 20px 0; }
        .log-console { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; height: 200px; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        .log-entry { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 12px; }
        .log-time { color: var(--text-muted); min-width: 80px; }
        .log-entry.info .log-message { color: var(--accent-blue); }
        .log-entry.success .log-message { color: var(--accent-green); }
        .log-entry.warning .log-message { color: var(--accent-yellow); }
        .log-entry.error .log-message { color: var(--accent-red); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 600; }
        .data-table td { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .training-progress { background: var(--bg-tertiary); border-radius: 12px; padding: 24px; margin: 20px 0; }
        .epoch-display { text-align: center; margin-bottom: 20px; }
        .epoch-number { font-size: 48px; font-weight: 700; font-family: 'JetBrains Mono', monospace; background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .epoch-label { font-size: 14px; color: var(--text-muted); }
        .alert-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 12px; border-left: 4px solid; }
        .alert-item.bullish { border-color: var(--accent-green); }
        .alert-item.bearish { border-color: var(--accent-red); }
        .alert-icon { font-size: 28px; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; margin-bottom: 4px; }
        .alert-details { font-size: 13px; color: var(--text-secondary); }
        .alert-time { font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .model-arch { display: flex; justify-content: center; align-items: center; gap: 20px; padding: 30px; flex-wrap: wrap; }
        .layer-box { background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary)); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px 24px; text-align: center; }
        .layer-name { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .layer-units { font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent-purple); }
        .layer-arrow { font-size: 24px; color: var(--accent-blue); }
        .switch-container { display: flex; align-items: center; gap: 12px; }
        .switch { width: 52px; height: 28px; background: var(--bg-tertiary); border-radius: 14px; cursor: pointer; position: relative; transition: all 0.3s ease; border: 2px solid var(--border-color); }
        .switch::before { content: ''; position: absolute; width: 20px; height: 20px; background: var(--text-muted); border-radius: 50%; top: 2px; left: 2px; transition: all 0.3s ease; }
        .switch.active { background: linear-gradient(135deg, var(--accent-green), var(--accent-blue)); border-color: transparent; }
        .switch.active::before { transform: translateX(24px); background: white; }
        .alerts-container { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <!-- ========== LOGIN SCREEN ========== -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <div class="login-logo">
                <div class="login-logo-icon">ü§ñ</div>
                <h1>Options AI Predictor</h1>
                <p>Sistema de Previs√£o com IA</p>
            </div>
            
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="login-error" id="loginError">
                    <span>‚ö†Ô∏è</span>
                    <span id="loginErrorText">Senha incorreta</span>
                </div>
                
                <div class="login-input-group">
                    <label>Senha de Acesso</label>
                    <div class="login-input-wrapper">
                        <span class="icon">üîê</span>
                        <input 
                            type="password" 
                            class="login-input" 
                            id="loginPassword" 
                            placeholder="Digite sua senha"
                            autocomplete="current-password"
                            required
                        >
                        <button type="button" class="toggle-password" onclick="togglePasswordVisibility()">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
                
                <label class="remember-me">
                    <input type="checkbox" id="rememberMe">
                    <span class="checkbox-custom"></span>
                    <span>Lembrar neste dispositivo</span>
                </label>
                
                <button type="submit" class="login-btn">
                    <span>üöÄ</span>
                    <span>Acessar Sistema</span>
                </button>
            </form>
            
            <div class="login-footer">
                <p>Acesso restrito ao propriet√°rio do sistema</p>
                <div class="security-badge">
                    <span>üîí</span>
                    <span>Protegido com SHA-256</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MAIN APPLICATION ========== -->
    <div class="app-container" id="appContainer">
        <div class="container">
            <header class="header">
                <div class="logo">
                    <div class="logo-icon">ü§ñ</div>
                    <div class="logo-text"><h1>Options AI Predictor</h1><span>v1.0 ‚Ä¢ TensorFlow.js</span></div>
                </div>
                <div class="status-badges">
                    <div class="badge badge-model"><div class="pulse pulse-purple"></div><span id="modelStatus">Modelo: N√£o treinado</span></div>
                    <div class="badge badge-api"><div class="pulse pulse-green"></div>Brapi.dev</div>
                    <div class="badge badge-telegram"><div class="pulse pulse-blue"></div>Telegram</div>
                    <div class="badge badge-logout" onclick="handleLogout()">üö™ Sair</div>
                </div>
            </header>

            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="predict">üéØ Predi√ß√£o</button>
                <button class="nav-tab" data-tab="train">üß† Treinar IA</button>
                <button class="nav-tab" data-tab="backtest">üìä Backtest</button>
                <button class="nav-tab" data-tab="monitor">üì° Monitor</button>
                <button class="nav-tab" data-tab="config">‚öôÔ∏è Config</button>
            </nav>

            <!-- PREDI√á√ÉO -->
            <div id="predict" class="tab-panel active">
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üéØ Gerar Previs√£o</h3></div>
                        <div class="form-group"><label class="form-label">Ativo (Ticker)</label><input type="text" class="form-input" id="predictTicker" value="PETR4" placeholder="Ex: PETR4, VALE3"></div>
                        <div class="grid-2">
                            <div class="form-group"><label class="form-label">Horizonte</label><select class="form-select" id="predictHorizon"><option value="3">3 dias</option><option value="5" selected>5 dias</option><option value="10">10 dias</option></select></div>
                            <div class="form-group"><label class="form-label">Confian√ßa M√≠n.</label><select class="form-select" id="minConfidence"><option value="0.5">50%</option><option value="0.6" selected>60%</option><option value="0.7">70%</option></select></div>
                        </div>
                        <button class="btn btn-primary btn-lg" style="width:100%;margin-top:12px" onclick="generatePrediction()" id="btnPredict">üîÆ Analisar</button>
                        <div class="progress-container" id="predictProgress" style="display:none"><div class="progress-label"><span>Analisando...</span><span id="predictProgressPercent">0%</span></div><div class="progress-bar"><div class="progress-fill" id="predictProgressBar" style="width:0%"></div></div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üìà Resultado</h3></div>
                        <div class="prediction-display" id="predictionDisplay"><div class="prediction-icon">üîÆ</div><div class="prediction-label">Tend√™ncia Prevista</div><div class="prediction-trend" id="predTrend">‚Äî</div><div class="confidence-bar"><div class="confidence-fill" id="confBar" style="width:0%"></div></div><div class="prediction-confidence" id="predConf">Confian√ßa: ‚Äî</div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">üí° Estrat√©gias de Op√ß√µes</h3></div>
                    <div class="grid-3" id="strategyCards">
                        <div class="strategy-card"><div class="strategy-icon">üìû</div><div class="strategy-name">Compra CALL</div><div class="strategy-desc">Aposta na alta do ativo</div><div class="strategy-stats"><div class="strategy-stat"><div class="strategy-stat-value" id="callProb">‚Äî</div><div>Prob</div></div><div class="strategy-stat"><div class="strategy-stat-value" style="color:var(--accent-green)">+‚àû</div><div>Lucro M√°x</div></div></div></div>
                        <div class="strategy-card"><div class="strategy-icon">üìâ</div><div class="strategy-name">Compra PUT</div><div class="strategy-desc">Aposta na queda do ativo</div><div class="strategy-stats"><div class="strategy-stat"><div class="strategy-stat-value" id="putProb">‚Äî</div><div>Prob</div></div><div class="strategy-stat"><div class="strategy-stat-value" style="color:var(--accent-green)">+‚àû</div><div>Lucro M√°x</div></div></div></div>
                        <div class="strategy-card"><div class="strategy-icon">üõ°Ô∏è</div><div class="strategy-name">Venda Coberta</div><div class="strategy-desc">Mercado lateral/leve alta</div><div class="strategy-stats"><div class="strategy-stat"><div class="strategy-stat-value" id="coveredProb">‚Äî</div><div>Prob</div></div><div class="strategy-stat"><div class="strategy-stat-value" style="color:var(--accent-yellow)">Pr√™mio</div><div>Lucro M√°x</div></div></div></div>
                    </div>
                </div>
            </div>

            <!-- TREINAMENTO -->
            <div id="train" class="tab-panel">
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üß¨ Config do Modelo</h3></div>
                        <div class="form-group"><label class="form-label">Ativos (separados por v√≠rgula)</label><input type="text" class="form-input" id="trainTicker" value="PETR4,VALE3,ITUB4,BBDC4" placeholder="Ex: PETR4,VALE3,ITUB4"></div>
                        <div class="grid-2">
                            <div class="form-group"><label class="form-label">Per√≠odo</label><select class="form-select" id="trainPeriod"><option value="3">3 meses</option><option value="6">6 meses</option><option value="12" selected>12 meses</option><option value="24">24 meses</option></select></div>
                            <div class="form-group"><label class="form-label">√âpocas</label><select class="form-select" id="trainEpochs"><option value="50">50</option><option value="100" selected>100</option><option value="200">200</option><option value="500">500</option></select></div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group"><label class="form-label">Learning Rate</label><select class="form-select" id="learningRate"><option value="0.001" selected>0.001</option><option value="0.0005">0.0005</option><option value="0.0001">0.0001</option></select></div>
                            <div class="form-group"><label class="form-label">Batch Size</label><select class="form-select" id="batchSize"><option value="16">16</option><option value="32" selected>32</option><option value="64">64</option></select></div>
                        </div>
                        <div style="margin-top:16px;padding:16px;background:var(--bg-tertiary);border-radius:8px">
                            <label class="form-label" style="margin-bottom:12px">üèóÔ∏è Arquitetura Neural (Neur√¥nios por camada)</label>
                            <div class="grid-3">
                                <div class="form-group" style="margin-bottom:0"><label class="form-label">Camada 1</label><select class="form-select" id="layer1"><option value="32">32</option><option value="64" selected>64</option><option value="128">128</option></select></div>
                                <div class="form-group" style="margin-bottom:0"><label class="form-label">Camada 2</label><select class="form-select" id="layer2"><option value="16">16</option><option value="32" selected>32</option><option value="64">64</option></select></div>
                                <div class="form-group" style="margin-bottom:0"><label class="form-label">Camada 3</label><select class="form-select" id="layer3"><option value="8">8</option><option value="16" selected>16</option><option value="32">32</option></select></div>
                            </div>
                            <div class="form-group" style="margin-top:12px;margin-bottom:0"><label class="form-label">Dropout</label><select class="form-select" id="dropoutRate"><option value="0.1">10%</option><option value="0.2" selected>20%</option><option value="0.3">30%</option><option value="0.4">40%</option></select></div>
                        </div>
                        <button class="btn btn-primary btn-lg" style="width:100%;margin-top:16px" onclick="startTraining()" id="btnTrain">üöÄ Iniciar Treinamento</button>
                        <button class="btn btn-secondary" style="width:100%;margin-top:12px" onclick="resetModel()">üóëÔ∏è Resetar Modelo</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üèóÔ∏è Arquitetura Neural</h3></div>
                        <div class="model-arch" id="archDisplay">
                            <div class="layer-box"><div class="layer-name">Input</div><div class="layer-units">10</div></div><div class="layer-arrow">‚Üí</div>
                            <div class="layer-box"><div class="layer-name">Dense</div><div class="layer-units" id="archL1">64</div></div><div class="layer-arrow">‚Üí</div>
                            <div class="layer-box"><div class="layer-name">Dense</div><div class="layer-units" id="archL2">32</div></div><div class="layer-arrow">‚Üí</div>
                            <div class="layer-box"><div class="layer-name">Dense</div><div class="layer-units" id="archL3">16</div></div><div class="layer-arrow">‚Üí</div>
                            <div class="layer-box"><div class="layer-name">Output</div><div class="layer-units">3</div></div>
                        </div>
                        <div style="text-align:center;color:var(--text-secondary);font-size:13px;margin-top:16px"><strong>Features:</strong> Pre√ßo, Volume, RSI, MACD, Sinal, Hist, Stoch K/D, Williams, Volatilidade<br><strong>Output:</strong> [Alta, Baixa, Lateral]</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">üìà Progresso</h3></div>
                    <div class="training-progress">
                        <div class="epoch-display"><div class="epoch-number" id="currentEpoch">0</div><div class="epoch-label">√âpoca</div></div>
                        <div class="grid-4">
                            <div class="metric-card green"><div class="metric-label">Acc Treino</div><div class="metric-value green" id="trainAccuracy">‚Äî</div></div>
                            <div class="metric-card blue"><div class="metric-label">Acc Val</div><div class="metric-value blue" id="valAccuracy">‚Äî</div></div>
                            <div class="metric-card purple"><div class="metric-label">Loss</div><div class="metric-value purple" id="trainLoss">‚Äî</div></div>
                            <div class="metric-card yellow"><div class="metric-label">Val Loss</div><div class="metric-value yellow" id="valLoss">‚Äî</div></div>
                        </div>
                        <div class="progress-container"><div class="progress-label"><span>Progresso</span><span id="trainProgressPercent">0%</span></div><div class="progress-bar"><div class="progress-fill" id="trainProgressBar" style="width:0%"></div></div></div>
                    </div>
                    <div class="chart-container"><canvas id="trainingChart"></canvas></div>
                </div>
                <div class="card"><div class="card-header"><h3 class="card-title">üìã Log</h3><button class="btn btn-secondary" onclick="clearTrainLog()">Limpar</button></div><div class="log-console" id="trainLog"></div></div>
            </div>

            <!-- BACKTEST -->
            <div id="backtest" class="tab-panel">
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üî¨ Configurar Backtest</h3></div>
                        <div class="form-group"><label class="form-label">Ativo</label><input type="text" class="form-input" id="backtestTicker" value="PETR4"></div>
                        <div class="grid-2">
                            <div class="form-group"><label class="form-label">Per√≠odo</label><select class="form-select" id="backtestPeriod"><option value="1">1 m√™s</option><option value="3" selected>3 meses</option><option value="6">6 meses</option></select></div>
                            <div class="form-group"><label class="form-label">Capital</label><input type="number" class="form-input" id="backtestCapital" value="10000"></div>
                        </div>
                        <div class="form-group"><label class="form-label">Estrat√©gia</label><select class="form-select" id="backtestStrategy"><option value="all">Todas</option><option value="call">Calls</option><option value="put">Puts</option></select></div>
                        <button class="btn btn-primary btn-lg" style="width:100%;margin-top:16px" onclick="runBacktest()" id="btnBacktest">‚ñ∂Ô∏è Executar</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üèÜ Resultados</h3></div>
                        <div class="grid-2">
                            <div class="metric-card green"><div class="metric-label">Retorno</div><div class="metric-value green" id="btReturn">‚Äî</div></div>
                            <div class="metric-card blue"><div class="metric-label">Acerto</div><div class="metric-value blue" id="btWinRate">‚Äî</div></div>
                            <div class="metric-card purple"><div class="metric-label">Trades</div><div class="metric-value purple" id="btTrades">‚Äî</div></div>
                            <div class="metric-card yellow"><div class="metric-label">Sharpe</div><div class="metric-value yellow" id="btSharpe">‚Äî</div></div>
                        </div>
                        <div class="grid-2" style="margin-top:16px">
                            <div class="metric-card green"><div class="metric-label">Max Ganho</div><div class="metric-value green" id="btMaxWin">‚Äî</div></div>
                            <div class="metric-card red"><div class="metric-label">Max Perda</div><div class="metric-value red" id="btMaxLoss">‚Äî</div></div>
                        </div>
                    </div>
                </div>
                <div class="card"><div class="card-header"><h3 class="card-title">üìà Evolu√ß√£o</h3></div><div class="chart-container"><canvas id="backtestChart"></canvas></div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">üìã Opera√ß√µes</h3></div><div style="overflow-x:auto"><table class="data-table"><thead><tr><th>Data</th><th>Tipo</th><th>Dir</th><th>Entrada</th><th>Sa√≠da</th><th>Result</th><th>‚úì</th></tr></thead><tbody id="backtestBody"><tr><td colspan="7" style="text-align:center;color:var(--text-muted)">Execute um backtest</td></tr></tbody></table></div></div>
            </div>

            <!-- MONITOR -->
            <div id="monitor" class="tab-panel">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">üì° Monitor Autom√°tico</h3><div class="switch-container"><span>Monitor</span><div class="switch" id="monitorSwitch" onclick="toggleMonitor()"></div></div></div>
                    <div class="grid-3">
                        <div class="form-group"><label class="form-label">Ativos</label><input type="text" class="form-input" id="monitorTickers" value="PETR4,VALE3,ITUB4,BBDC4"></div>
                        <div class="form-group"><label class="form-label">Intervalo</label><select class="form-select" id="monitorInterval"><option value="5">5 min</option><option value="15" selected>15 min</option><option value="30">30 min</option><option value="60">1h</option></select></div>
                        <div class="form-group"><label class="form-label">Conf M√≠n</label><select class="form-select" id="monitorMinConf"><option value="0.6">60%</option><option value="0.7" selected>70%</option><option value="0.8">80%</option></select></div>
                    </div>
                    <div class="switch-container" style="margin-top:16px"><div class="switch" id="telegramSwitch" onclick="toggleTelegram()"></div><span>Alertas Telegram</span></div>
                </div>
                <div class="grid-2">
                    <div class="card"><div class="card-header"><h3 class="card-title">üìä Status</h3><button class="btn btn-secondary" onclick="refreshStatus()">üîÑ Atualizar</button></div><div style="overflow-x:auto"><table class="data-table"><thead><tr><th>Ativo</th><th>Pre√ßo</th><th>Var</th><th>RSI</th><th>Tend</th><th>Conf</th><th>Hora</th></tr></thead><tbody id="statusBody"><tr><td colspan="7" style="text-align:center;color:var(--text-muted)">Ative o monitor</td></tr></tbody></table></div></div>
                    <div class="card"><div class="card-header"><h3 class="card-title">üîî Alertas</h3><button class="btn btn-secondary" onclick="clearAlerts()">Limpar</button></div><div class="alerts-container" id="alertsContainer"><div style="text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:48px;margin-bottom:16px">üì≠</div><p>Nenhum alerta</p></div></div></div>
                </div>
            </div>

            <!-- CONFIGURA√á√ïES -->
            <div id="config" class="tab-panel">
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üîë APIs</h3></div>
                        <div class="form-group"><label class="form-label">Token Brapi.dev</label><input type="text" class="form-input" id="brapiToken" placeholder="Seu token"></div>
                        <div class="form-group"><label class="form-label">Token Telegram Bot</label><input type="text" class="form-input" id="telegramToken" placeholder="Bot token"></div>
                        <div class="form-group"><label class="form-label">Chat ID Telegram</label><input type="text" class="form-input" id="telegramChatId" placeholder="Seu chat ID"></div>
                        <button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="saveConfig()">üíæ Salvar</button>
                        <button class="btn btn-secondary" style="width:100%;margin-top:12px" onclick="testTelegram()">üì± Testar Telegram</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üîê Seguran√ßa</h3></div>
                        <div class="form-group"><label class="form-label">Nova Senha</label><input type="password" class="form-input" id="newPassword" placeholder="Digite nova senha"></div>
                        <div class="form-group"><label class="form-label">Confirmar Senha</label><input type="password" class="form-input" id="confirmPassword" placeholder="Confirme a senha"></div>
                        <button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="changePassword()">üîÑ Alterar Senha</button>
                        <div style="margin-top:20px;padding:16px;background:var(--bg-tertiary);border-radius:8px">
                            <p style="color:var(--text-muted);font-size:13px">‚ö†Ô∏è A senha √© armazenada com hash SHA-256 no seu navegador. Se voc√™ esquecer, precisar√° limpar o localStorage.</p>
                        </div>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üíæ Modelo</h3></div>
                        <p style="color:var(--text-secondary);margin-bottom:16px" id="configModelStatus">Status: N√£o treinado</p>
                        <div style="display:flex;gap:12px;flex-wrap:wrap">
                            <button class="btn btn-secondary" onclick="exportModel()">üì• Exportar</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('importModel').click()">üì§ Importar</button>
                            <input type="file" id="importModel" style="display:none" accept=".json" onchange="importModel(event)">
                        </div>
                        <div style="margin-top:20px;padding:16px;background:var(--bg-tertiary);border-radius:8px;font-size:13px">
                            <div class="grid-2">
                                <div><span style="color:var(--text-muted)">Ativo:</span> <span id="modelTicker">‚Äî</span></div>
                                <div><span style="color:var(--text-muted)">√âpocas:</span> <span id="modelEpochs">‚Äî</span></div>
                                <div><span style="color:var(--text-muted)">Acur√°cia:</span> <span id="modelAccuracy">‚Äî</span></div>
                                <div><span style="color:var(--text-muted)">Data:</span> <span id="modelDate">‚Äî</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">‚ö†Ô∏è Aviso</h3></div>
                    <div style="padding:20px;background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.3);border-radius:8px">
                        <p style="color:var(--accent-orange);margin-bottom:12px;font-weight:600">üö® Sistema EXPERIMENTAL</p>
                        <ul style="color:var(--text-secondary);font-size:14px;line-height:1.8;padding-left:20px">
                            <li>Mercados s√£o imprevis√≠veis</li>
                            <li>IA n√£o garante resultados</li>
                            <li>Fa√ßa sua pr√≥pria an√°lise</li>
                            <li>Nunca invista mais do que pode perder</li>
                        </ul>
                    </div>
                </div>
                <div class="card"><div class="card-header"><h3 class="card-title">üìã Log</h3><button class="btn btn-secondary" onclick="clearSystemLog()">Limpar</button></div><div class="log-console" id="systemLog"></div></div>
            </div>
        </div>
    </div>

    <script>
        // ========== AUTHENTICATION SYSTEM ==========
        // Default password hash (SHA-256 of "trading123")
        const DEFAULT_PASSWORD_HASH = '26088f7527885e5be0007523dc12f3fabd585501375a0b5744842e41dfd6e394'; // "123" for initial setup
        
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        function getStoredPasswordHash() {
            return localStorage.getItem('aiPredictor_passwordHash') || DEFAULT_PASSWORD_HASH;
        }
        
        function setPasswordHash(hash) {
            localStorage.setItem('aiPredictor_passwordHash', hash);
        }
        
        function isRemembered() {
            const remembered = localStorage.getItem('aiPredictor_remembered');
            const expiry = localStorage.getItem('aiPredictor_rememberExpiry');
            if (remembered === 'true' && expiry) {
                if (new Date().getTime() < parseInt(expiry)) {
                    return true;
                } else {
                    // Expired, clear remember
                    localStorage.removeItem('aiPredictor_remembered');
                    localStorage.removeItem('aiPredictor_rememberExpiry');
                }
            }
            return false;
        }
        
        function setRemembered(remember) {
            if (remember) {
                localStorage.setItem('aiPredictor_remembered', 'true');
                // Remember for 30 days
                const expiry = new Date().getTime() + (30 * 24 * 60 * 60 * 1000);
                localStorage.setItem('aiPredictor_rememberExpiry', expiry.toString());
            } else {
                localStorage.removeItem('aiPredictor_remembered');
                localStorage.removeItem('aiPredictor_rememberExpiry');
            }
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const errorDiv = document.getElementById('loginError');
            
            const inputHash = await hashPassword(password);
            const storedHash = getStoredPasswordHash();
            
            if (inputHash === storedHash) {
                setRemembered(rememberMe);
                showApp();
            } else {
                errorDiv.classList.add('show');
                document.getElementById('loginPassword').value = '';
                setTimeout(() => errorDiv.classList.remove('show'), 3000);
            }
        }
        
        function handleLogout() {
            if (confirm('Deseja sair do sistema?')) {
                setRemembered(false);
                hideApp();
            }
        }
        
        function showApp() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('appContainer').classList.add('visible');
        }
        
        function hideApp() {
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('visible');
            document.getElementById('loginPassword').value = '';
        }
        
        function togglePasswordVisibility() {
            const input = document.getElementById('loginPassword');
            const btn = document.querySelector('.toggle-password');
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }
        
        async function changePassword() {
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            
            if (!newPass || newPass.length < 4) {
                alert('A senha deve ter no m√≠nimo 4 caracteres!');
                return;
            }
            
            if (newPass !== confirmPass) {
                alert('As senhas n√£o conferem!');
                return;
            }
            
            const newHash = await hashPassword(newPass);
            setPasswordHash(newHash);
            
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            alert('‚úÖ Senha alterada com sucesso!');
            logSystem('success', 'Senha do sistema alterada');
        }
        
        // Check if user is remembered on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (isRemembered()) {
                showApp();
            }
            initApp();
        });
        
        // ========== MAIN APPLICATION ==========
        const CONFIG = { brapiToken: '7MDRfFVL4HJfTX2Z5Jqvje', telegramToken: '8561952462:AAGxR3RubYNSDPpNcQATRyS7bqAhU1E1oB0', telegramChatId: '7990738315', proxyUrl: 'https://corsproxy.io/?' };
        let model = null, modelInfo = { ticker: null, epochs: null, accuracy: null, trainDate: null, trained: false };
        let trainingChart = null, backtestChart = null, monitorInterval = null, telegramEnabled = false, alerts = [];

        function initApp() {
            loadConfig();
            initTabs();
            initCharts();
            logSystem('info', 'Sistema iniciado');
            logSystem('info', 'TensorFlow.js: ' + tf.version.tfjs);
            loadModelFromStorage();
        }

        function initTabs() { document.querySelectorAll('.nav-tab').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active')); tab.classList.add('active'); document.getElementById(tab.dataset.tab).classList.add('active'); }); }); }

        function initCharts() {
            trainingChart = new Chart(document.getElementById('trainingChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'Acc Treino', data: [], borderColor: '#00ff88', tension: 0.4 }, { label: 'Acc Val', data: [], borderColor: '#00d4ff', tension: 0.4 }, { label: 'Loss', data: [], borderColor: '#a855f7', tension: 0.4, yAxisID: 'y1' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#a0a0b0' } } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#606070' } }, y: { position: 'left', grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#606070' }, min: 0, max: 1 }, y1: { position: 'right', grid: { display: false }, ticks: { color: '#a855f7' } } } } });
            backtestChart = new Chart(document.getElementById('backtestChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'Capital', data: [], borderColor: '#00ff88', backgroundColor: 'rgba(0,255,136,0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#a0a0b0' } } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#606070' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#606070' } } } } });
        }

        function logSystem(type, msg) { const log = document.getElementById('systemLog'); log.innerHTML += `<div class="log-entry ${type}"><span class="log-time">${new Date().toLocaleTimeString('pt-BR')}</span><span class="log-message">${msg}</span></div>`; log.scrollTop = log.scrollHeight; }
        function logTrain(type, msg) { const log = document.getElementById('trainLog'); log.innerHTML += `<div class="log-entry ${type}"><span class="log-time">${new Date().toLocaleTimeString('pt-BR')}</span><span class="log-message">${msg}</span></div>`; log.scrollTop = log.scrollHeight; }
        function clearSystemLog() { document.getElementById('systemLog').innerHTML = ''; }
        function clearTrainLog() { document.getElementById('trainLog').innerHTML = ''; }
        function clearAlerts() { alerts = []; renderAlerts(); }

        async function fetchStockData(ticker, range = '1y') { const url = `${CONFIG.proxyUrl}https://brapi.dev/api/quote/${ticker}?range=${range}&interval=1d&token=${CONFIG.brapiToken}`; const response = await fetch(url); const data = await response.json(); if (data.results && data.results[0]) return data.results[0]; throw new Error('Dados n√£o encontrados'); }
        async function fetchHistoricalPrices(ticker, months = 12) { const range = months <= 3 ? '3mo' : months <= 6 ? '6mo' : months <= 12 ? '1y' : '2y'; const url = `${CONFIG.proxyUrl}https://brapi.dev/api/quote/${ticker}?range=${range}&interval=1d&token=${CONFIG.brapiToken}`; const response = await fetch(url); const data = await response.json(); if (data.results && data.results[0] && data.results[0].historicalDataPrice) return data.results[0].historicalDataPrice; throw new Error('Dados hist√≥ricos n√£o encontrados'); }

        function calculateRSI(prices, period = 14) { if (prices.length < period + 1) return []; const rsi = [], gains = [], losses = []; for (let i = 1; i < prices.length; i++) { const change = prices[i] - prices[i - 1]; gains.push(change > 0 ? change : 0); losses.push(change < 0 ? Math.abs(change) : 0); } let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period; let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period; for (let i = 0; i < period; i++) rsi.push(null); rsi.push(avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss))); for (let i = period; i < gains.length; i++) { avgGain = (avgGain * (period - 1) + gains[i]) / period; avgLoss = (avgLoss * (period - 1) + losses[i]) / period; rsi.push(avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss))); } return rsi; }
        function calculateEMA(prices, period) { const ema = [], multiplier = 2 / (period + 1); let sum = 0; for (let i = 0; i < period; i++) { sum += prices[i]; ema.push(null); } ema[period - 1] = sum / period; for (let i = period; i < prices.length; i++) ema.push((prices[i] - ema[i - 1]) * multiplier + ema[i - 1]); return ema; }
        function calculateMACD(prices, fast = 12, slow = 26, signal = 9) { const emaFast = calculateEMA(prices, fast), emaSlow = calculateEMA(prices, slow), macd = []; for (let i = 0; i < prices.length; i++) macd.push(emaFast[i] !== null && emaSlow[i] !== null ? emaFast[i] - emaSlow[i] : null); const validMACD = macd.filter(v => v !== null), signalLine = calculateEMA(validMACD, signal), histogram = []; let signalIdx = 0; for (let i = 0; i < macd.length; i++) { if (macd[i] !== null && signalLine[signalIdx] !== null) { histogram.push(macd[i] - signalLine[signalIdx]); signalIdx++; } else histogram.push(null); } return { macd, signal: signalLine, histogram }; }
        function calculateStochastic(highs, lows, closes, kPeriod = 14, dPeriod = 3) { const k = [], d = []; for (let i = 0; i < kPeriod - 1; i++) k.push(null); for (let i = kPeriod - 1; i < closes.length; i++) { const hh = Math.max(...highs.slice(i - kPeriod + 1, i + 1)), ll = Math.min(...lows.slice(i - kPeriod + 1, i + 1)); k.push(hh === ll ? 50 : ((closes[i] - ll) / (hh - ll)) * 100); } for (let i = 0; i < k.length; i++) { if (i < kPeriod + dPeriod - 2) d.push(null); else { const validK = k.slice(i - dPeriod + 1, i + 1).filter(v => v !== null); d.push(validK.reduce((a, b) => a + b, 0) / validK.length); } } return { k, d }; }
        function calculateWilliamsR(highs, lows, closes, period = 14) { const wr = []; for (let i = 0; i < period - 1; i++) wr.push(null); for (let i = period - 1; i < closes.length; i++) { const hh = Math.max(...highs.slice(i - period + 1, i + 1)), ll = Math.min(...lows.slice(i - period + 1, i + 1)); wr.push(hh === ll ? -50 : ((hh - closes[i]) / (hh - ll)) * -100); } return wr; }
        function calculateVolatility(prices, period = 20) { const returns = []; for (let i = 1; i < prices.length; i++) returns.push((prices[i] - prices[i-1]) / prices[i-1]); const volatility = []; for (let i = 0; i < period; i++) volatility.push(null); for (let i = period; i < returns.length; i++) { const slice = returns.slice(i - period, i), mean = slice.reduce((a, b) => a + b, 0) / period, variance = slice.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period; volatility.push(Math.sqrt(variance) * Math.sqrt(252)); } return volatility; }

        function createModel(l1=64, l2=32, l3=16, dropout=0.2) { const m = tf.sequential(); m.add(tf.layers.dense({ inputShape: [10], units: l1, activation: 'relu', kernelInitializer: 'heNormal' })); m.add(tf.layers.dropout({ rate: dropout })); m.add(tf.layers.dense({ units: l2, activation: 'relu', kernelInitializer: 'heNormal' })); m.add(tf.layers.dropout({ rate: dropout })); m.add(tf.layers.dense({ units: l3, activation: 'relu', kernelInitializer: 'heNormal' })); m.add(tf.layers.dense({ units: 3, activation: 'softmax' })); return m; }

        function prepareTrainingData(historicalData, lookAhead = 5) {
            const closes = historicalData.map(d => d.close), highs = historicalData.map(d => d.high), lows = historicalData.map(d => d.low), volumes = historicalData.map(d => d.volume);
            const rsi = calculateRSI(closes), macdData = calculateMACD(closes), stoch = calculateStochastic(highs, lows, closes), williams = calculateWilliamsR(highs, lows, closes), volatility = calculateVolatility(closes);
            const priceMin = Math.min(...closes), priceMax = Math.max(...closes), volMin = Math.min(...volumes), volMax = Math.max(...volumes);
            const features = [], labels = [];
            for (let i = 30; i < closes.length - lookAhead; i++) {
                features.push([(closes[i] - priceMin) / (priceMax - priceMin), (volumes[i] - volMin) / (volMax - volMin), (rsi[i] || 50) / 100, (macdData.macd[i] || 0) / (priceMax - priceMin), (macdData.signal[i - 26 + 1] || 0) / (priceMax - priceMin), (macdData.histogram[i] || 0) / (priceMax - priceMin), (stoch.k[i] || 50) / 100, (stoch.d[i] || 50) / 100, ((williams[i] || -50) + 100) / 100, Math.min((volatility[i] || 0.2) / 1, 1)]);
                const change = (closes[i + lookAhead] - closes[i]) / closes[i];
                labels.push(change > 0.01 ? [1,0,0] : change < -0.01 ? [0,1,0] : [0,0,1]);
            }
            return { features, labels };
        }

        async function startTraining() {
            const tickers = document.getElementById('trainTicker').value.toUpperCase().split(',').map(t => t.trim()).filter(t => t);
            const months = parseInt(document.getElementById('trainPeriod').value), epochs = parseInt(document.getElementById('trainEpochs').value), lr = parseFloat(document.getElementById('learningRate').value), batch = parseInt(document.getElementById('batchSize').value);
            document.getElementById('btnTrain').disabled = true; logTrain('info', `Iniciando: ${tickers.join(', ')}, ${epochs} √©pocas`);
            try {
                let allFeatures = [], allLabels = [];
                for (const ticker of tickers) {
                    logTrain('info', `Buscando ${ticker}...`);
                    const hist = await fetchHistoricalPrices(ticker, months);
                    logTrain('success', `${ticker}: ${hist.length} registros`);
                    const { features, labels } = prepareTrainingData(hist);
                    allFeatures = allFeatures.concat(features);
                    allLabels = allLabels.concat(labels);
                }
                logTrain('success', `Total: ${allFeatures.length} amostras de ${tickers.length} ativos`);
                
                const indices = allFeatures.map((_, i) => i);
                for (let i = indices.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [indices[i], indices[j]] = [indices[j], indices[i]]; }
                const shuffledFeatures = indices.map(i => allFeatures[i]);
                const shuffledLabels = indices.map(i => allLabels[i]);
                
                const splitIdx = Math.floor(shuffledFeatures.length * 0.8), xTrain = tf.tensor2d(shuffledFeatures.slice(0, splitIdx)), yTrain = tf.tensor2d(shuffledLabels.slice(0, splitIdx)), xVal = tf.tensor2d(shuffledFeatures.slice(splitIdx)), yVal = tf.tensor2d(shuffledLabels.slice(splitIdx));
                logTrain('info', 'Criando modelo...'); const l1 = parseInt(document.getElementById('layer1').value), l2 = parseInt(document.getElementById('layer2').value), l3 = parseInt(document.getElementById('layer3').value), dropout = parseFloat(document.getElementById('dropoutRate').value); model = createModel(l1, l2, l3, dropout); logTrain('info', `Arquitetura: ${l1}‚Üí${l2}‚Üí${l3}, Dropout: ${dropout*100}%`); model.compile({ optimizer: tf.train.adam(lr), loss: 'categoricalCrossentropy', metrics: ['accuracy'] });
                trainingChart.data.labels = []; trainingChart.data.datasets.forEach(d => d.data = []); trainingChart.update();
                logTrain('info', 'Treinando...');
                await model.fit(xTrain, yTrain, { epochs, batchSize: batch, validationData: [xVal, yVal], shuffle: true, callbacks: { onEpochEnd: (epoch, logs) => { document.getElementById('currentEpoch').textContent = epoch + 1; document.getElementById('trainAccuracy').textContent = (logs.acc * 100).toFixed(1) + '%'; document.getElementById('valAccuracy').textContent = (logs.val_acc * 100).toFixed(1) + '%'; document.getElementById('trainLoss').textContent = logs.loss.toFixed(4); document.getElementById('valLoss').textContent = logs.val_loss.toFixed(4); const pct = ((epoch + 1) / epochs * 100).toFixed(0); document.getElementById('trainProgressPercent').textContent = pct + '%'; document.getElementById('trainProgressBar').style.width = pct + '%'; trainingChart.data.labels.push(epoch + 1); trainingChart.data.datasets[0].data.push(logs.acc); trainingChart.data.datasets[1].data.push(logs.val_acc); trainingChart.data.datasets[2].data.push(logs.loss); trainingChart.update(); if ((epoch + 1) % 20 === 0) logTrain('info', `√âpoca ${epoch + 1}: Acc ${(logs.acc * 100).toFixed(1)}%`); } } });
                modelInfo = { ticker: tickers.join(','), epochs, accuracy: document.getElementById('valAccuracy').textContent, trainDate: new Date().toLocaleString('pt-BR'), trained: true }; updateModelStatus(); saveModelToStorage(); logTrain('success', '‚úÖ Treinamento conclu√≠do!');
                xTrain.dispose(); yTrain.dispose(); xVal.dispose(); yVal.dispose();
            } catch (error) { logTrain('error', `Erro: ${error.message}`); }
            document.getElementById('btnTrain').disabled = false;
        }

        function updateModelStatus() { const status = modelInfo.trained ? `Treinado (${modelInfo.ticker})` : 'N√£o treinado'; document.getElementById('modelStatus').textContent = `Modelo: ${status}`; document.getElementById('configModelStatus').textContent = status; document.getElementById('modelTicker').textContent = modelInfo.ticker || '‚Äî'; document.getElementById('modelEpochs').textContent = modelInfo.epochs || '‚Äî'; document.getElementById('modelAccuracy').textContent = modelInfo.accuracy || '‚Äî'; document.getElementById('modelDate').textContent = modelInfo.trainDate || '‚Äî'; }
        function resetModel() { if (confirm('Resetar modelo?')) { model = null; modelInfo = { ticker: null, epochs: null, accuracy: null, trainDate: null, trained: false }; updateModelStatus(); localStorage.removeItem('aiModel'); localStorage.removeItem('aiModelInfo'); logSystem('warning', 'Modelo resetado'); } }
        async function saveModelToStorage() { if (model) { await model.save('localstorage://options-ai-model'); localStorage.setItem('aiModelInfo', JSON.stringify(modelInfo)); logSystem('success', 'Modelo salvo'); } }
        async function loadModelFromStorage() { try { const saved = localStorage.getItem('aiModelInfo'); if (saved) { modelInfo = JSON.parse(saved); model = await tf.loadLayersModel('localstorage://options-ai-model'); updateModelStatus(); logSystem('success', 'Modelo carregado'); } } catch (e) { logSystem('info', 'Nenhum modelo salvo'); } }
        async function exportModel() { if (!model) { alert('Nenhum modelo!'); return; } await model.save('downloads://options-ai-model'); logSystem('success', 'Modelo exportado'); }
        async function importModel(event) { const files = event.target.files; if (files.length === 0) return; try { model = await tf.loadLayersModel(tf.io.browserFiles([files[0], files[1]])); modelInfo.trained = true; modelInfo.trainDate = new Date().toLocaleString('pt-BR'); updateModelStatus(); saveModelToStorage(); logSystem('success', 'Modelo importado'); } catch (e) { logSystem('error', `Erro: ${e.message}`); } }

        async function generatePrediction() {
            if (!model || !modelInfo.trained) { alert('Modelo n√£o treinado!'); return; }
            const ticker = document.getElementById('predictTicker').value.toUpperCase(), horizon = parseInt(document.getElementById('predictHorizon').value), minConf = parseFloat(document.getElementById('minConfidence').value);
            document.getElementById('btnPredict').disabled = true; document.getElementById('predictProgress').style.display = 'block';
            try {
                updatePredictProgress(20, 'Buscando dados...'); const hist = await fetchHistoricalPrices(ticker, 3);
                updatePredictProgress(50, 'Calculando indicadores...');
                const closes = hist.map(d => d.close), highs = hist.map(d => d.high), lows = hist.map(d => d.low), volumes = hist.map(d => d.volume);
                const rsi = calculateRSI(closes), macdData = calculateMACD(closes), stoch = calculateStochastic(highs, lows, closes), williams = calculateWilliamsR(highs, lows, closes), volatility = calculateVolatility(closes);
                const lastIdx = closes.length - 1, priceMin = Math.min(...closes), priceMax = Math.max(...closes), volMin = Math.min(...volumes), volMax = Math.max(...volumes);
                updatePredictProgress(80, 'Executando modelo...');
                const input = tf.tensor2d([[(closes[lastIdx] - priceMin) / (priceMax - priceMin), (volumes[lastIdx] - volMin) / (volMax - volMin), (rsi[lastIdx] || 50) / 100, (macdData.macd[lastIdx] || 0) / (priceMax - priceMin), (macdData.signal[lastIdx - 26 + 1] || 0) / (priceMax - priceMin), (macdData.histogram[lastIdx] || 0) / (priceMax - priceMin), (stoch.k[lastIdx] || 50) / 100, (stoch.d[lastIdx] || 50) / 100, ((williams[lastIdx] || -50) + 100) / 100, Math.min((volatility[lastIdx] || 0.2) / 1, 1)]]);
                const prediction = model.predict(input), probs = await prediction.data();
                input.dispose(); prediction.dispose();
                const [pAlta, pBaixa, pLateral] = probs, maxIdx = probs.indexOf(Math.max(...probs)), labels = ['ALTA', 'BAIXA', 'LATERAL'], trend = labels[maxIdx], confidence = probs[maxIdx];
                updatePredictProgress(100, 'Conclu√≠do!');
                displayPrediction(trend, confidence, { alta: pAlta, baixa: pBaixa, lateral: pLateral });
                logSystem('success', `Previs√£o ${ticker}: ${trend} (${(confidence * 100).toFixed(1)}%)`);
            } catch (error) { logSystem('error', `Erro: ${error.message}`); alert('Erro: ' + error.message); }
            document.getElementById('btnPredict').disabled = false;
            setTimeout(() => { document.getElementById('predictProgress').style.display = 'none'; }, 1000);
        }

        function updatePredictProgress(pct, text) { document.getElementById('predictProgressPercent').textContent = pct + '%'; document.getElementById('predictProgressBar').style.width = pct + '%'; }

        function displayPrediction(trend, confidence, probs) {
            const display = document.getElementById('predictionDisplay'), icon = trend === 'ALTA' ? 'üìà' : trend === 'BAIXA' ? 'üìâ' : '‚û°Ô∏è', color = trend === 'ALTA' ? 'var(--accent-green)' : trend === 'BAIXA' ? 'var(--accent-red)' : 'var(--accent-yellow)';
            display.className = `prediction-display ${trend === 'ALTA' ? 'bullish' : trend === 'BAIXA' ? 'bearish' : 'neutral'}`;
            document.getElementById('predTrend').textContent = trend; document.getElementById('predTrend').style.color = color;
            document.getElementById('predConf').textContent = `Confian√ßa: ${(confidence * 100).toFixed(1)}%`;
            const confBar = document.getElementById('confBar'); confBar.style.width = (confidence * 100) + '%'; confBar.className = `confidence-fill ${confidence >= 0.7 ? 'high' : confidence >= 0.5 ? 'medium' : 'low'}`;
            document.querySelector('.prediction-icon').textContent = icon;
            document.getElementById('callProb').textContent = (probs.alta * 100).toFixed(0) + '%'; document.getElementById('putProb').textContent = (probs.baixa * 100).toFixed(0) + '%'; document.getElementById('coveredProb').textContent = (probs.lateral * 100).toFixed(0) + '%';
            const cards = document.querySelectorAll('.strategy-card'); cards.forEach(c => c.classList.remove('recommended'));
            if (trend === 'ALTA') cards[0].classList.add('recommended'); else if (trend === 'BAIXA') cards[1].classList.add('recommended'); else cards[2].classList.add('recommended');
        }

        async function runBacktest() {
            if (!model || !modelInfo.trained) { alert('Modelo n√£o treinado!'); return; }
            const ticker = document.getElementById('backtestTicker').value.toUpperCase(), months = parseInt(document.getElementById('backtestPeriod').value), capital = parseFloat(document.getElementById('backtestCapital').value), strategy = document.getElementById('backtestStrategy').value;
            document.getElementById('btnBacktest').disabled = true; logSystem('info', `Backtest: ${ticker}, ${months} meses`);
            try {
                const hist = await fetchHistoricalPrices(ticker, months);
                const closes = hist.map(d => d.close), highs = hist.map(d => d.high), lows = hist.map(d => d.low), volumes = hist.map(d => d.volume);
                const rsi = calculateRSI(closes), macdData = calculateMACD(closes), stoch = calculateStochastic(highs, lows, closes), williams = calculateWilliamsR(highs, lows, closes), volatility = calculateVolatility(closes);
                const priceMin = Math.min(...closes), priceMax = Math.max(...closes), volMin = Math.min(...volumes), volMax = Math.max(...volumes);
                const trades = [], capitalHistory = [capital]; let currentCapital = capital;
                for (let i = 35; i < closes.length - 5; i += 5) {
                    const input = tf.tensor2d([[(closes[i] - priceMin) / (priceMax - priceMin), (volumes[i] - volMin) / (volMax - volMin), (rsi[i] || 50) / 100, (macdData.macd[i] || 0) / (priceMax - priceMin), (macdData.signal[i - 26 + 1] || 0) / (priceMax - priceMin), (macdData.histogram[i] || 0) / (priceMax - priceMin), (stoch.k[i] || 50) / 100, (stoch.d[i] || 50) / 100, ((williams[i] || -50) + 100) / 100, Math.min((volatility[i] || 0.2) / 1, 1)]]);
                    const prediction = model.predict(input), probs = await prediction.data();
                    input.dispose(); prediction.dispose();
                    const [pAlta, pBaixa] = probs, maxIdx = probs.indexOf(Math.max(...probs)), labels = ['ALTA', 'BAIXA', 'LATERAL'], trend = labels[maxIdx];
                    if (trend === 'LATERAL') continue; if (strategy === 'call' && trend !== 'ALTA') continue; if (strategy === 'put' && trend !== 'BAIXA') continue;
                    const entryPrice = closes[i], exitPrice = closes[Math.min(i + 5, closes.length - 1)], actualChange = (exitPrice - entryPrice) / entryPrice;
                    let tradeResult = 0, correct = false;
                    if (trend === 'ALTA') { tradeResult = actualChange * 3; correct = actualChange > 0; } else { tradeResult = -actualChange * 3; correct = actualChange < 0; }
                    currentCapital *= (1 + tradeResult); capitalHistory.push(currentCapital);
                    trades.push({ date: hist[i].date ? new Date(hist[i].date * 1000).toLocaleDateString('pt-BR') : `Dia ${i}`, type: trend === 'ALTA' ? 'CALL' : 'PUT', direction: trend, entryPrice, exitPrice, result: tradeResult, correct });
                }
                const wins = trades.filter(t => t.correct).length, winRate = trades.length > 0 ? (wins / trades.length) * 100 : 0, totalReturn = ((currentCapital - capital) / capital) * 100;
                const returns = trades.map(t => t.result), avgReturn = returns.length > 0 ? returns.reduce((a, b) => a + b, 0) / returns.length : 0;
                const stdReturn = returns.length > 0 ? Math.sqrt(returns.reduce((a, b) => a + Math.pow(b - avgReturn, 2), 0) / returns.length) : 1;
                const sharpe = stdReturn > 0 ? (avgReturn / stdReturn) * Math.sqrt(252 / 5) : 0, maxWin = returns.length > 0 ? Math.max(...returns) * 100 : 0, maxLoss = returns.length > 0 ? Math.min(...returns) * 100 : 0;
                document.getElementById('btReturn').textContent = totalReturn.toFixed(1) + '%'; document.getElementById('btReturn').style.color = totalReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                document.getElementById('btWinRate').textContent = winRate.toFixed(1) + '%'; document.getElementById('btTrades').textContent = trades.length;
                document.getElementById('btSharpe').textContent = sharpe.toFixed(2); document.getElementById('btMaxWin').textContent = '+' + maxWin.toFixed(1) + '%'; document.getElementById('btMaxLoss').textContent = maxLoss.toFixed(1) + '%';
                backtestChart.data.labels = capitalHistory.map((_, i) => i); backtestChart.data.datasets[0].data = capitalHistory; backtestChart.update();
                const tbody = document.getElementById('backtestBody');
                tbody.innerHTML = trades.length === 0 ? '<tr><td colspan="7" style="text-align:center">Nenhuma opera√ß√£o</td></tr>' : trades.map(t => `<tr><td>${t.date}</td><td>${t.type}</td><td>${t.direction}</td><td>R$ ${t.entryPrice.toFixed(2)}</td><td>R$ ${t.exitPrice.toFixed(2)}</td><td style="color:${t.result >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${t.result >= 0 ? '+' : ''}${(t.result * 100).toFixed(1)}%</td><td>${t.correct ? '‚úÖ' : '‚ùå'}</td></tr>`).join('');
                logSystem('success', `Backtest: ${totalReturn.toFixed(1)}% retorno, ${winRate.toFixed(0)}% acerto`);
            } catch (error) { logSystem('error', `Erro: ${error.message}`); }
            document.getElementById('btnBacktest').disabled = false;
        }

        function toggleMonitor() { const sw = document.getElementById('monitorSwitch'); if (sw.classList.contains('active')) { sw.classList.remove('active'); clearInterval(monitorInterval); monitorInterval = null; logSystem('info', 'Monitor desativado'); } else { if (!model || !modelInfo.trained) { alert('Modelo n√£o treinado!'); return; } sw.classList.add('active'); runMonitor(); const interval = parseInt(document.getElementById('monitorInterval').value) * 60 * 1000; monitorInterval = setInterval(runMonitor, interval); logSystem('success', 'Monitor ativado'); } }
        function toggleTelegram() { telegramEnabled = !telegramEnabled; document.getElementById('telegramSwitch').classList.toggle('active', telegramEnabled); logSystem('info', `Telegram: ${telegramEnabled ? 'ativado' : 'desativado'}`); }

        async function runMonitor() {
            const tickers = document.getElementById('monitorTickers').value.toUpperCase().split(',').map(t => t.trim()), minConf = parseFloat(document.getElementById('monitorMinConf').value);
            logSystem('info', `Analisando ${tickers.length} ativos...`);
            const statusBody = document.getElementById('statusBody'); statusBody.innerHTML = '';
            for (const ticker of tickers) {
                try {
                    const data = await fetchStockData(ticker, '3mo'), hist = data.historicalDataPrice || []; if (hist.length < 30) continue;
                    const closes = hist.map(d => d.close), highs = hist.map(d => d.high), lows = hist.map(d => d.low), volumes = hist.map(d => d.volume);
                    const rsi = calculateRSI(closes), macdData = calculateMACD(closes), stoch = calculateStochastic(highs, lows, closes), williams = calculateWilliamsR(highs, lows, closes), volatility = calculateVolatility(closes);
                    const lastIdx = closes.length - 1, priceMin = Math.min(...closes), priceMax = Math.max(...closes), volMin = Math.min(...volumes), volMax = Math.max(...volumes);
                    const input = tf.tensor2d([[(closes[lastIdx] - priceMin) / (priceMax - priceMin), (volumes[lastIdx] - volMin) / (volMax - volMin), (rsi[lastIdx] || 50) / 100, (macdData.macd[lastIdx] || 0) / (priceMax - priceMin), (macdData.signal[lastIdx - 26 + 1] || 0) / (priceMax - priceMin), (macdData.histogram[lastIdx] || 0) / (priceMax - priceMin), (stoch.k[lastIdx] || 50) / 100, (stoch.d[lastIdx] || 50) / 100, ((williams[lastIdx] || -50) + 100) / 100, Math.min((volatility[lastIdx] || 0.2) / 1, 1)]]);
                    const prediction = model.predict(input), probs = await prediction.data(), maxIdx = probs.indexOf(Math.max(...probs)), confidence = probs[maxIdx], labels = ['ALTA', 'BAIXA', 'LATERAL'], trend = labels[maxIdx];
                    input.dispose(); prediction.dispose();
                    const currentPrice = data.regularMarketPrice || closes[lastIdx], change = data.regularMarketChangePercent || 0;
                    const trendColor = trend === 'ALTA' ? 'var(--accent-green)' : trend === 'BAIXA' ? 'var(--accent-red)' : 'var(--accent-yellow)';
                    const confColor = confidence >= 0.7 ? 'var(--accent-green)' : confidence >= 0.5 ? 'var(--accent-yellow)' : 'var(--accent-red)';
                    statusBody.innerHTML += `<tr><td><strong>${ticker}</strong></td><td>R$ ${currentPrice.toFixed(2)}</td><td style="color:${change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</td><td>${(rsi[lastIdx] || 0).toFixed(1)}</td><td style="color:${trendColor}">${trend}</td><td style="color:${confColor}">${(confidence * 100).toFixed(1)}%</td><td>${new Date().toLocaleTimeString('pt-BR')}</td></tr>`;
                    if (confidence >= minConf && trend !== 'LATERAL') { addAlert(ticker, trend, confidence, currentPrice); if (telegramEnabled) sendTelegramAlert(ticker, trend, confidence, currentPrice, 5); }
                } catch (e) { statusBody.innerHTML += `<tr><td>${ticker}</td><td colspan="6" style="color:var(--accent-red)">Erro</td></tr>`; }
            }
            logSystem('success', 'An√°lise conclu√≠da');
        }

        async function refreshStatus() { if (!model || !modelInfo.trained) { alert('Modelo n√£o treinado!'); return; } await runMonitor(); }
        function addAlert(ticker, trend, confidence, price) { alerts.unshift({ ticker, trend, confidence, price, time: new Date() }); if (alerts.length > 50) alerts.pop(); renderAlerts(); }
        function renderAlerts() { const container = document.getElementById('alertsContainer'); if (alerts.length === 0) { container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:48px;margin-bottom:16px">üì≠</div><p>Nenhum alerta</p></div>`; return; } container.innerHTML = alerts.map(a => `<div class="alert-item ${a.trend === 'ALTA' ? 'bullish' : 'bearish'}"><div class="alert-icon">${a.trend === 'ALTA' ? 'üìà' : 'üìâ'}</div><div class="alert-content"><div class="alert-title">${a.ticker} - ${a.trend}</div><div class="alert-details">Confian√ßa: ${(a.confidence * 100).toFixed(1)}% | R$ ${a.price.toFixed(2)}</div></div><div class="alert-time">${a.time.toLocaleString('pt-BR')}</div></div>`).join(''); }

        async function sendTelegramAlert(ticker, trend, confidence, price, horizon) { const message = `ü§ñ *Options AI Predictor*\n\nüìä *Sinal!*\n\nüìå ${ticker}\nüìà ${trend}\nüéØ ${(confidence * 100).toFixed(1)}%\nüí∞ R$ ${price.toFixed(2)}\n‚è±Ô∏è ${horizon} dias\n\nüí° ${trend === 'ALTA' ? 'Compra CALL' : trend === 'BAIXA' ? 'Compra PUT' : 'Venda coberta'}`; try { await fetch(`https://api.telegram.org/bot${CONFIG.telegramToken}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: CONFIG.telegramChatId, text: message, parse_mode: 'Markdown' }) }); logSystem('success', `Telegram: ${ticker}`); } catch (e) { logSystem('error', `Telegram erro: ${e.message}`); } }
        async function testTelegram() { try { const message = `ü§ñ *Options AI Predictor*\n\n‚úÖ Teste OK!\nüìÖ ${new Date().toLocaleString('pt-BR')}`; const response = await fetch(`https://api.telegram.org/bot${CONFIG.telegramToken}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: CONFIG.telegramChatId, text: message, parse_mode: 'Markdown' }) }); const data = await response.json(); if (data.ok) { alert('‚úÖ Telegram OK!'); logSystem('success', 'Telegram teste OK'); } else throw new Error(data.description); } catch (e) { alert('‚ùå Erro: ' + e.message); logSystem('error', `Telegram falhou: ${e.message}`); } }

        function loadConfig() { const saved = localStorage.getItem('aiPredictorConfig'); if (saved) Object.assign(CONFIG, JSON.parse(saved)); document.getElementById('brapiToken').value = CONFIG.brapiToken; document.getElementById('telegramToken').value = CONFIG.telegramToken; document.getElementById('telegramChatId').value = CONFIG.telegramChatId; updateArchDisplay(); document.getElementById('layer1').addEventListener('change', updateArchDisplay); document.getElementById('layer2').addEventListener('change', updateArchDisplay); document.getElementById('layer3').addEventListener('change', updateArchDisplay); }
        function updateArchDisplay() { document.getElementById('archL1').textContent = document.getElementById('layer1').value; document.getElementById('archL2').textContent = document.getElementById('layer2').value; document.getElementById('archL3').textContent = document.getElementById('layer3').value; }
        function saveConfig() { CONFIG.brapiToken = document.getElementById('brapiToken').value; CONFIG.telegramToken = document.getElementById('telegramToken').value; CONFIG.telegramChatId = document.getElementById('telegramChatId').value; localStorage.setItem('aiPredictorConfig', JSON.stringify(CONFIG)); alert('‚úÖ Salvo!'); logSystem('success', 'Config salva'); }
    </script>
</body>
</html>
